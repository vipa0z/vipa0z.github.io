
## LLMNR  ?

**LLMNR** is a protocol that allows both IPv4 and IPv6 hosts to perform name resolution for hosts on the same local network without requiring a DNS server or DNS configuration.

When a host’s DNS query fails (i.e., the DNS server doesn’t know the name), the host broadcasts an LLMNR request on the local network to see if any other host can answer.

LLMNR is the successor to NetBIOS. **NetBIOS** (Network Basic Input/Output System) is an older protocol that was heavily used in early versions of Windows networking. **NBT-NS** is a component of NetBIOS over TCP/IP (NBT) and is responsible for name registration and resolution. Like LLMNR, NBT-NS is a fallback protocol when DNS resolution fails. It allows local name resolution within a LAN.

---
## ATTACKS ON LLMNR AND NBT-NS

Man-in-the-Middle attack on Link-Local Multicast Name Resolution (LLMNR) and NetBIOS Name Service (NBT-NS) broadcasts. Depending on the network, this attack may provide low-privileged or administrative level password hashes that can be cracked offline or even cleartext credentials. Though not covered in this module, these hashes can also sometimes be used to perform an SMB Relay attack to authenticate to a host or multiple hosts in the domain with administrative privileges without having to crack the password hash offline. Let's dive in!

![](Screenshots/Pasted%20image%2020250110221008.png)
When a LLMNR event occurs in the network and is maliciously responded to, the attacker will obtain sensitive information, including:

- The IP address of the victim (in this example: 10.0.3.7)
- The domain and username of the victim (in this example: MARVEL\fcastle)
- **The victim’s password hash**
```
$ sudo responder -I ens224

[MSSQL] NTLMv2 Client   : 172.16.5.130
[MSSQL] NTLMv2 Username : BLACKWOOD\lab_adm
[MSSQL] NTLMv2 Hash     : lab_adm::BLACKWOOD:17bd3616ae5ae735:37445EA686F4F4AB31A926CE8DC9337B:0101000000000000C803A79F6B34DB010560929741EE13260000000002000800330031003000460001001E00570049004E002D003200410055004D0044005300310046004200590035000400140033003100300046002E004C004F00430041004C0003003400570049004E002D003200410055004D0044005300310046004200590035002E0033003100300046002E004C004F00430041004C000500140033003100300046002E004C004F00430041004C0008003000300000000000000000000000003000004D3EE3E0EF4507A593F734CAF09736AE3243A0112E76CFFE2B5C90399AFD80300A0010000000000000000000000000000000000009003A004D005300530051004C005300760063002F00610063006100640065006D0079002D00650061002D0077006500620030003A0031003400330033000000000000000000
```

![](Screenshots//Pasted%20image%2020250110222243.png)

#hashcracking 
to crack the hashes (ntlmv2) you have to get the last captured ntlmv2 hash or try 2 hashes from the bottom.
```
tail -n 2 /usr/share/responder/logs/nSMB
```
## LLMNR Poisoning From Windows

```powershell-session
PS C:\htb> Invoke-Inveigh Y -NBNS Y -ConsoleOutput Y -FileOutput Y
```

```
hashcat backupagent-ntlm -m 5600 /pathtowordlist
```




Use C# INVEIGH as its updated
`outdated powershell version of inveigh`
```powershell-session
PS C:\htb> Invoke-Inveigh Y -NBNS Y -ConsoleOutput Y -FileOutput Y
GET USER
```


---

## Remediation

Mitre ATT&CK lists this technique as [ID: T1557.001](https://attack.mitre.org/techniques/T1557/001), `Adversary-in-the-Middle: LLMNR/NBT-NS Poisoning and SMB Relay`.

There are a few ways to mitigate this attack. To ensure that these spoofing attacks are not possible, we can disable LLMNR and NBT-NS. As a word of caution, it is always worth slowly testing out a significant change like this to your environment carefully before rolling it out fully. As penetration testers, we can recommend these remediation steps, but should clearly communicate to our clients that they should test these changes heavily to ensure that disabling both protocols does not break anything in the network.

We can disable LLMNR in Group Policy by going to Computer Configuration --> Administrative Templates --> Network --> DNS Client and enabling "Turn OFF Multicast Name Resolution."

![image](https://academy.hackthebox.com/storage/modules/143/llmnr_disable.png)

**To disable NBT-NS via GPO in Active Directory, we can simply write a PowerShell script (see below) and save it in Startup Scripts.**

```
   |   | |---| |set-ItemProperty -Path HKLM:\SYSTEM\CurrentControlSet\services\NetBT\Parameters\Interfaces\tcpip* -Name NetbiosOptions -Value 2|   `
```

[![Powershell script to disable NBT-NS saved in the Startup Scripts section](https://tcm-sec.com/wp-content/uploads/2023/09/llmnr-6.png "llmnr-6")](https://tcm-sec.com/wp-content/uploads/2023/09/llmnr-6.png "Powershell script to disable NBT-NS saved in the Startup Scripts section")

**Now add the script to Startup Scripts in Computer Configuration > Policies > Windows Settings > Scripts > Startup**

[![Add script to Startup Scripts in Active Directory GPO](https://tcm-sec.com/wp-content/uploads/2023/09/llmnr-7.png "llmnr-7")](https://tcm-sec.com/wp-content/uploads/2023/09/llmnr-7.png "Add script to Startup Scripts in Active Directory GPO")

Click the image to view in full resolution.

### Confirming Our Mitigation

**We can confirm that we have mitigated LLMNR by running the following command in PowerShell and receiving a ‘0’ in return:**

`   |   | |---| |$(Get-ItemProperty -Path "HKLM:\Software\Policies\Microsoft\Windows NT\DNSClient" -name EnableMulticast).EnableMulticast|   `

[![Properly remediated LLMNR](https://tcm-sec.com/wp-content/uploads/2023/09/llmnr-8.png "llmnr-8")](https://tcm-sec.com/wp-content/uploads/2023/09/llmnr-8.png "Properly remediated LLMNR")

Click the image to view in full resolution.

**We can confirm that we have mitigated NBT-NS by running the following command in cmd.exe and receiving a ‘2’ in return:**

`   |   | |---| |wmic nicconfig get caption,index,TcpipNetbiosOptions|   `

![Properly remediated NBT-NS](https://tcm-sec.com/wp-content/uploads/2023/09/llmnr-9.png "llmnr-9")

### Alternate Defenses

If a company must use or cannot disable LLMNR/NBT-NS in Active Directory, the best course of action is to:

- Require Network Access Control.
- Require strong user passwords (e.g., >14 characters in length and limit common word usage). The more complex and longer the password, the harder it is for an attacker to crack the hash.

![image](https://academy.hackthebox.com/storage/modules/143/disable_nbtns.png)

While it is not possible to disable NBT-NS directly via GPO, we can create a PowerShell script under Computer Configuration --> Windows Settings --> Script (Startup/Shutdown) --> Startup with something like the following:

```powershell

$regkey = "HKLM:SYSTEM\CurrentControlSet\services\NetBT\Parameters\Interfaces"
Get-ChildItem $regkey |foreach { Set-ItemProperty -Path "$regkey\$($_.pschildname)" -Name NetbiosOptions -Value 2 -Verbose}
```

In the Local Group Policy Editor, we will need to double click on `Startup`, choose the `PowerShell Scripts` tab, and select "For this GPO, run scripts in the following order" to `Run Windows PowerShell scripts first`, and then click on `Add` and choose the script. For these changes to occur, we would have to either reboot the target system or restart the network adapter.

![image](https://academy.hackthebox.com/storage/modules/143/nbtns_gpo.png)

To push this out to all hosts in a domain, we could create a GPO using `Group Policy Management` on the Domain Controller and host the script on the SYSVOL share in the scripts folder and then call it via its UNC path such as:

`\\blackwood.local\SYSVOL\blackwood.local\scripts`

Once the GPO is applied to specific OUs and those hosts are restarted, the script will run at the next reboot and disable NBT-NS, provided that the script still exists on the SYSVOL share and is accessible by the host over the network.

![image](https://academy.hackthebox.com/storage/modules/143/nbtns_gpo_dc.png)

Other mitigations include filtering network traffic to block LLMNR/NetBIOS traffic and enabling SMB Signing to prevent NTLM relay attacks. Network intrusion detection and prevention systems can also be used to mitigate this activity, while network segmentation can be used to isolate hosts that require LLMNR or NetBIOS enabled to operate correctly.


start with DNS
dns translates names to IPs
so for Users in a corporate:
on WIndows explorer, smb server with name , `//share/dog` => `10.10.5.6`
on browser, web server (HTTP/S), `mego.com` => `172.16.5.500`


## SMB Relay Attack

The ultimate goal of an SMB relay attack is to exploit the trust inherent in authentication protocols to gain unauthorized access to resources on a network. By intercepting and relaying SMB authentication messages, attackers can trick servers into granting them the same privileges as legitimate users, enabling them to compromise systems and access sensitive data.

- **Relaying the Authentication:** The attacker takes the intercepted authentication messages and relays them to another server or service on the network. This server thinks it's communicating with the original client, unaware of the relay attack.
- **Exploiting Weaknesses:** The success of the attack often relies on the target server's weak authentication settings. For example, if the server doesn't require SMB signing or message integrity, it's more vulnerable.
    
- **Abusing Authentication:** The attacker isn't stealing credentials; they're re-using them. The server trusts the relayed credentials, giving the attacker the same level of access as the original user.
## NTLM Relay attacks

**"Forcing" Authentication to a Controlled Server:**
**Once the victim connects to the attackers controlled server using one of the methods above, the attacker then "forces" that connection to authenticate against another service, such as a server they wish to target for lateral movement or a server they control as a relay.

- **Forcing Authentication to a Target:** NTLMrelayx uses the relayed authentication to then force another computer to authenticate to another service (usually SMB) with the user credentials they received from the target. When forcing the authentication, NTLMrelayx forces a computer to authenticate back to itself using the account.
    
- **SAM Database Access:** Since the attacker now has authentication as an administrator on a target computer, they can use that to attempt to access the local SAM database.
    
- **Dumping SAM Hashes:** Once authenticated, NTLMrelayx can execute a command to dump the SAM database on the target system. Tools like secretsdump.py or mimikatz within NTLMrelayx are used to extract the password hashes from the SAM file.

a tool like `Responder` listening for network requests. `Responder` is powerful because it can act as a 'poisoner' across multiple protocols and server types, but an example of this is how it can poison `DNS` queries. For instance, when users mistype server names, they trigger a process that `Responder` can exploit.

Imagine a user intending to access `//fileserver/`, but accidentally types `//file/`. The primary `DNS` server (usually an Active Directory server) will return a "not found" error because it doesn't have an IP address mapping for //file/.

When this happens, the user's machine tries to find the server by using 
**Link-Local Multicast Name Resolution (LLMNR)** and potentially 
**NetBIOS Name Service (NBT-NS)**. It sends out multicast `DNS` queries on the local network asking if any machine has an IP address associated with the server name `//file/`.

Here's where `Responder` comes into play. It actively listens for these unresolved name queries. **Among other protocols it can respond to,** `Responder` impersonates a legitimate `DNS` server and responds to the query for `//file/`. The user's machine, thinking it's connected to the requested server, then attempts an SMB connection to `Responder`. This attempt includes the user's username and `NTLMv2` hash, which Windows relies on heavily for authentication.

`Responder` captures this `NTLMv2` hash. While `NTLMv2` is more secure than `NTLMv1`, this captured hash can be potentially cracked or, more commonly, used in a relay attack. In a relay attack, this stolen hash can be replayed to access another machine on the network with `ntlmRelayX` tool.

The key here is to remember that this specific example showcases how `Responder` poisons `DNS` queries, but its broader capability allows it to poison various other network protocols and requests.

- **Misdirection (e.g., LLMNR/NBNS Poisoning):**
    
    - As we've discussed, if DNS fails, the client might use LLMNR or NetBIOS Name Service (NBNS) to find the server's address.
        
    - The attacker poisons these requests, responding as if they are the intended server, providing their IP address instead.
        
    - The client now attempts to connect to the attacker's machine, thinking it's the real server.
        
- **Other Misdirection Methods:**
    
    - **WPAD Poisoning:** Web Proxy Auto-Discovery (WPAD) is used to automatically configure proxy settings. By poisoning WPAD, an attacker can redirect a client's traffic to their proxy, allowing them to intercept traffic including SMB requests to a legitimate file server.
        
    - **Malicious Links:** Attackers send malicious links (e.g., in emails or web pages) that force the victim to authenticate to an SMB share on a server controlled by the attacker.
        
    - **Compromised Servers:** If the attacker has compromised a server that the client uses (e.g., a web server, an app server) then they can force the client to authenticate to an SMB share under the attacker's control.
        
    - **ARP Poisoning:** The attacker can use ARP poisoning to intercept traffic from the victim computer by poisoning their ARP cache.
        
- **"Forcing" Authentication to a Controlled Server:**
    
    - Once the victim connects to the attackers controlled server using one of the methods above, the attacker then "forces" that connection to authenticate against another service, such as a server they wish to target for lateral movement or a server they control as a relay.
# SMB RELAY & LLMNR POISONING

|                    |                                  |                                             |
| ------------------ | -------------------------------- | ------------------------------------------- |
| Feature            | LLMNR Poisoning                  | SMB Relay Attack                            |
| **Primary Target** | Name Resolution                  | Authentication                              |
| **Mechanism**      | Intercepts LLMNR broadcasts      | Intercepts and Relays Authentication        |
| **Type of Attack** | Passive Interception             | Active Man-in-the-Middle                    |
| **Scope**          | Local Network (Broadcast Domain) | Can move across the network                 |
| **Main Objective** | Capture Credentials              | Gain Unauthorized Access                    |
| **Protocol**       | LLMNR                            | SMB (Typically, but can be other protocols) |
| **Credential Use** | For password cracking offline    | For accessing resources on other systems    |
#SMB-LLMNR-diff



#smb-signing-check
```
nmap <target> --script smb-security-mode -p445 
```
