<%- partial('_partial/head') %>

    <body class="gitbook-page">
        <%- partial('_partial/navigation') %>

            <div class="gitbook-container">
                <%
                    // Server-side image loading logic via helper
                    var allImages = get_all_images('chsheet');
                    var randomImage = allImages.length > 0 ? allImages[Math.floor(Math.random() * allImages.length)] : '';
                %>
                    <!-- 1. Sidebar -->
                    <aside class="gitbook-sidebar" id="gitbook-sidebar">
                        <div class="sidebar-resizer" id="sidebar-resizer"></div>
                        <div class="sidebar-header">
                            <div class="sidebar-logo">
                                <img src="/cheatsheets/wizard.png" alt="Wizard Logo"
                                    style="height: 48px; width: auto; margin-right: 8px; pointer-events: none;">
                                <span>0zAttacker's Cookbook</span>
                            </div>
                            <button class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                        </div>

                        <div class="sidebar-search">
                            <input type="text" id="docs-search" placeholder="Search documentation..." />
                            <i class="fa fa-search"></i>
                        </div>

                        <nav class="sidebar-nav" id="sidebar-nav">
                            <div class="loading-spinner">
                                <i class="fa fa-spinner fa-spin"></i>
                                <span>Loading...</span>
                            </div>
                        </nav>

                        <div class="sidebar-footer">
                            <a href="https://github.com/vipa0z/field-notes" target="_blank" rel="noopener">
                                <i class="fa fa-github"></i> View on GitHub
                            </a>
                        </div>
                    </aside>

                    <!-- 2. Sidebar Open Button (Visible when sidebar collapsed) -->
                    <button class="sidebar-open-btn" id="sidebar-open-btn" title="Open Sidebar">
                        <i class="fa fa-bars"></i>
                        <span>Menu</span>
                    </button>

                    <!-- 3. Markdown Body (Middle Column) -->
                    <main class="gitbook-main" id="gitbook-content">
                        <div class="content-header">
                            <button class="mobile-menu-btn" id="mobile-menu-btn" aria-label="Open Menu">
                                <i class="fa fa-bars"></i>
                            </button>
                            <div class="breadcrumb" id="breadcrumb">
                                <a href="/cheatsheets/">Home</a>
                            </div>
                            <div style="margin-left: auto;">
                                <button class="theme-toggle-btn"
                                    style="background:none; border:none; padding:8px; color:#888;"
                                    aria-label="Toggle theme">
                                    <i class="fa fa-moon-o"></i>
                                </button>
                            </div>
                        </div>

                        <article class="content-body" id="content-body">
                            <div class="welcome-screen">
                                <div class="welcome-image-container" id="rotating-image-container"
                                    data-images='<%- JSON.stringify(allImages) %>'
                                    style="position: relative; overflow: hidden; min-height: 200px; display: flex; align-items: center; justify-content: center; margin-bottom: 20px;">
                                    <% if (randomImage) { %>
                                        <img src="/images/chsheet/<%- encodeURIComponent(randomImage) %>"
                                            alt="Cheatsheet Background" id="rotating-image" class="welcome-image"
                                            style="max-width: 100%; height: auto; border-radius: 8px; pointer-events: none; opacity: 1; transition: opacity 0.5s ease-in-out;">
                                        <% } %>
                                </div>
                                <p class="welcome-description">
                                    My offensive security notes and cheatsheets covering vulnerability discovery in Web
                                    Apps, APIs, Internal networks, and Active Directory.

                                </p>

                                <div class="quick-links">
                                    <h3>Browse by Category</h3>
                                    <div class="quick-links-grid" id="quick-links-grid">
                                        <div class="loading-spinner">
                                            <i class="fa fa-spinner fa-spin"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </article>

                        <div class="content-footer">
                            <div class="nav-buttons">
                                <button class="nav-btn prev" id="prev-btn" disabled>
                                    <i class="fa fa-chevron-left"></i>
                                    <span>Previous</span>
                                </button>
                                <button class="nav-btn next" id="next-btn" disabled>
                                    <span>Next</span>
                                    <i class="fa fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                    </main>

                    <!-- 3. Meta (Right Column -> TOC) -->
                    <div class="meta">
                        <aside class="content-toc" id="content-toc">
                            <div class="toc-header">
                                <span>On this page</span>
                            </div>
                            <nav class="toc-nav" id="toc-nav">
                                <!-- TOC will be populated by JavaScript -->
                            </nav>
                        </aside>
                    </div>
            </div>

            <!-- Markdown Parser -->
            <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
            <!-- Syntax Highlighting -->
            <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-bash.min.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-python.min.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-powershell.min.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-sql.min.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-javascript.min.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-markup.min.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-css.min.js"></script>
            <script src="/js/gitbook.js"></script>

            <script>
                document.addEventListener('DOMContentLoaded', function () {
                    // Mobile Menu Button Logic
                    var mobileMenuBtn = document.getElementById('mobile-menu-btn');
                    var sidebar = document.getElementById('gitbook-sidebar');
                    var overlay = document.createElement('div');
                    overlay.className = 'sidebar-overlay';
                    document.body.appendChild(overlay);

                    if (mobileMenuBtn) {
                        mobileMenuBtn.addEventListener('click', function () {
                            sidebar.classList.toggle('open');
                            overlay.classList.toggle('active');
                        });

                        overlay.addEventListener('click', function () {
                            sidebar.classList.remove('open');
                            overlay.classList.remove('active');
                        });
                    }

                    // Image Rotation Logic
                    var imageContainer = document.getElementById('rotating-image-container');
                    var rotatingImage = document.getElementById('rotating-image');

                    if (imageContainer && rotatingImage) {
                        var imagesData = imageContainer.getAttribute('data-images');
                        var images = [];

                        try {
                            images = JSON.parse(imagesData);
                        } catch (e) {
                            console.error('Failed to parse images data:', e);
                        }

                        if (images && images.length > 1) {
                            var currentIndex = 0;

                            // Find current image index
                            var currentSrc = rotatingImage.src;
                            for (var i = 0; i < images.length; i++) {
                                if (currentSrc.includes(encodeURIComponent(images[i]))) {
                                    currentIndex = i;
                                    break;
                                }
                            }

                            setInterval(function () {
                                // Fade out
                                rotatingImage.style.opacity = '0';

                                setTimeout(function () {
                                    // Change image
                                    currentIndex = (currentIndex + 1) % images.length;
                                    rotatingImage.src = '/images/chsheet/' + encodeURIComponent(images[currentIndex]);

                                    // Fade in
                                    rotatingImage.style.opacity = '1';
                                }, 500); // Wait for fade out to complete
                            }, 5000); // Rotate every 5 seconds
                        }
                    }
                });
            </script>

            <%- partial('_partial/after_footer') %>
    </body>

    </html>
